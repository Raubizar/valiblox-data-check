<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Speedometer PDF Positioning</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <h1>Test Speedometer Positioning in PDF</h1>
    <button onclick="generateTestPDF()">Generate Test PDF</button>
    
    <script>
        // Helper function to draw speedometer chart
        const drawSpeedometer = (pdf, x, y, percentage, label) => {
            const radius = 15; // 30mm diameter = 15mm radius (smaller to fit better)
            const centerX = x + radius;
            const centerY = y + radius;
            
            // Save graphics state
            pdf.saveGraphicsState();
            
            // Draw arc segments for color coding using line segments
            const segments = 72; // Number of line segments to approximate arc (more for smoother curves)
            const angleStep = Math.PI / segments; // 180° in segments
            const arcThickness = 3;
            
            // Red zone (0-40%) - 180° to 108° (left side)
            pdf.setDrawColor(220, 38, 127);
            pdf.setLineWidth(arcThickness);
            for (let i = 0; i < Math.floor(segments * 0.4); i++) {
                const angle1 = Math.PI - (i * angleStep);
                const angle2 = Math.PI - ((i + 1) * angleStep);
                const x1 = centerX + Math.cos(angle1) * radius;
                const y1 = centerY + Math.sin(angle1) * radius;
                const x2 = centerX + Math.cos(angle2) * radius;
                const y2 = centerY + Math.sin(angle2) * radius;
                pdf.line(x1, y1, x2, y2);
            }
            
            // Yellow zone (40-80%) - 108° to 36°
            pdf.setDrawColor(234, 179, 8);
            for (let i = Math.floor(segments * 0.4); i < Math.floor(segments * 0.8); i++) {
                const angle1 = Math.PI - (i * angleStep);
                const angle2 = Math.PI - ((i + 1) * angleStep);
                const x1 = centerX + Math.cos(angle1) * radius;
                const y1 = centerY + Math.sin(angle1) * radius;
                const x2 = centerX + Math.cos(angle2) * radius;
                const y2 = centerY + Math.sin(angle2) * radius;
                pdf.line(x1, y1, x2, y2);
            }
            
            // Green zone (80-100%) - 36° to 0° (right side)
            pdf.setDrawColor(34, 197, 94);
            for (let i = Math.floor(segments * 0.8); i < segments; i++) {
                const angle1 = Math.PI - (i * angleStep);
                const angle2 = Math.PI - ((i + 1) * angleStep);
                const x1 = centerX + Math.cos(angle1) * radius;
                const y1 = centerY + Math.sin(angle1) * radius;
                const x2 = centerX + Math.cos(angle2) * radius;
                const y2 = centerY + Math.sin(angle2) * radius;
                pdf.line(x1, y1, x2, y2);
            }
            
            // Draw needle
            const needleAngle = Math.PI - (percentage / 100) * Math.PI; // 0% = 180°, 100% = 0°
            const needleLength = radius - 3;
            const needleEndX = centerX + Math.cos(needleAngle) * needleLength;
            const needleEndY = centerY + Math.sin(needleAngle) * needleLength;
            
            pdf.setDrawColor(60, 60, 60);
            pdf.setLineWidth(2);
            pdf.line(centerX, centerY, needleEndX, needleEndY);
            
            // Draw center circle
            pdf.setFillColor(60, 60, 60);
            pdf.circle(centerX, centerY, 2, 'F');
            
            // Add percentage text
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(12); // Reduced from 14 to fit smaller speedometer
            pdf.setFont('helvetica', 'bold');
            const percentText = `${percentage}%`;
            const textWidth = pdf.getTextWidth(percentText);
            pdf.text(percentText, centerX - textWidth/2, centerY + 6); // Adjusted Y position
            
            // Add label
            pdf.setFontSize(7); // Reduced from 8 to fit smaller speedometer
            pdf.setFont('helvetica', 'normal');
            const labelWidth = pdf.getTextWidth(label);
            pdf.text(label, centerX - labelWidth/2, centerY + 14); // Adjusted Y position
            
            // Restore graphics state
            pdf.restoreGraphicsState();
        };

        function generateTestPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            
            // Add title
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Speedometer Position Test', 20, 30);
            
            // Create a test table similar to the actual implementation
            let currentY = 50;
            const colWidths = [60, 30, 40, 40];
            const startX = 20;
            const tableWidth = colWidths.reduce((a, b) => a + b, 0);
            const rowHeight = 8;
            
            // Draw table header
            pdf.setFillColor(249, 250, 251);
            pdf.rect(startX, currentY - 6, tableWidth, rowHeight, 'F');
            
            pdf.setDrawColor(229, 231, 235);
            pdf.setLineWidth(0.3);
            let currentX = startX;
            colWidths.forEach((width) => {
                pdf.rect(currentX, currentY - 6, width, rowHeight, 'S');
                currentX += width;
            });
            
            // Table headers
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(0, 0, 0);
            
            pdf.text('Status', startX + 2, currentY);
            pdf.text('Count', startX + colWidths[0] + 2, currentY);
            pdf.text('Percentage', startX + colWidths[0] + colWidths[1] + 2, currentY);
            pdf.text('Match Rate', startX + colWidths[0] + colWidths[1] + colWidths[2] + 2, currentY);
            
            const tableStartY = currentY;
            currentY += rowHeight;
            
            // Add a few sample rows
            const sampleData = [
                { status: 'Matched', count: 9, percentage: 56, color: [0, 150, 0] },
                { status: 'Missing', count: 7, percentage: 44, color: [200, 0, 0] }
            ];
            
            pdf.setFont('helvetica', 'normal');
            sampleData.forEach((row, index) => {
                // Draw row background (alternating)
                if (index % 2 === 1) {
                    pdf.setFillColor(249, 250, 251);
                    pdf.rect(startX, currentY - 6, tableWidth, rowHeight, 'F');
                }
                
                // Draw row borders
                currentX = startX;
                colWidths.forEach((width) => {
                    pdf.rect(currentX, currentY - 6, width, rowHeight, 'S');
                    currentX += width;
                });
                
                // Row data
                pdf.setTextColor(...row.color);
                pdf.text(row.status, startX + 2, currentY);
                pdf.setTextColor(0, 0, 0);
                pdf.text(row.count.toString(), startX + colWidths[0] + 2, currentY);
                pdf.text(`${row.percentage}%`, startX + colWidths[0] + colWidths[1] + 2, currentY);
                
                if (row.status === 'Matched') {
                    pdf.setTextColor(...row.color);
                    pdf.text('56%', startX + colWidths[0] + colWidths[1] + colWidths[2] + 2, currentY);
                } else {
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('-', startX + colWidths[0] + colWidths[1] + colWidths[2] + 2, currentY);
                }
                
                currentY += rowHeight;
            });
            
            // Add speedometer chart in the Match Rate column area (NEW POSITIONING)
            const columnStart = startX + colWidths[0] + colWidths[1] + colWidths[2];
            const columnWidth = colWidths[3]; // Match Rate column width (40mm)
            const speedometerX = columnStart + (columnWidth - 30) / 2; // Center the 30mm speedometer in 40mm column
            const speedometerY = tableStartY + 8; // Position below the header row
            drawSpeedometer(pdf, speedometerX, speedometerY, 56, 'Match Rate');
            
            // Add some debug information
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Page width: ${pageWidth}mm`, 20, 120);
            pdf.text(`Table width: ${tableWidth}mm (starts at ${startX}mm, ends at ${startX + tableWidth}mm)`, 20, 125);
            pdf.text(`Match Rate column: ${columnWidth}mm wide, starts at ${columnStart}mm`, 20, 130);
            pdf.text(`Speedometer: 30mm diameter, positioned at X=${speedometerX}mm, Y=${speedometerY}mm`, 20, 135);
            pdf.text(`Speedometer should fit within column bounds: ${columnStart}mm to ${columnStart + columnWidth}mm`, 20, 140);
            
            // Draw column boundaries for visualization
            pdf.setDrawColor(255, 0, 0);
            pdf.setLineWidth(0.5);
            pdf.line(columnStart, tableStartY - 10, columnStart, tableStartY + 40);
            pdf.line(columnStart + columnWidth, tableStartY - 10, columnStart + columnWidth, tableStartY + 40);
            
            pdf.save('speedometer-position-test.pdf');
        }
    </script>
</body>
</html>
